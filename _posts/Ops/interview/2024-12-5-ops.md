# 运维

## 现在给你 300 台服务器，你怎么对他们进行管理

1. 记录管理：cmdb，以后的报表

2. 统一认证：ldap

3. 跳板机：非直连，安全

4. 批量管理工具：salt, ansible

jumpserver，内置 ansible，开源，python + django，可以进行按需修改

- https://bbs.fit2cloud.com/t/topic/924

## 什么是运维

总体来说，就是保障服务稳定性的岗位。

服务会有多种，基础服务（代码存储、用户存储、数据存储）、业务系统（对内业务 oa, erp、对外业务），这些服务，都是运维人员可以保障的。

## raid0,1,5

- raid0：最少 2 块盘。1 块磁盘坏掉，阵列无法正常工作。完全没有冗余，读写速度最快。N 块盘组合后的磁盘空间为：N。
- raid1：最少 2 块盘。只要 1 块磁盘正常，就可以正常工作。冗余最高，读速度最快，写速度最慢。N 块盘组合后的磁盘空间为：1。
- raid5：最少 3 块盘。1 块磁盘坏掉，还可以正常工作。N 块盘组合后的磁盘空间为：N-1。
- raid6：最少 4 块盘。2 块磁盘坏掉，还可以正常工作。N 块盘组合后的磁盘空间为：N-2。
- raid10：最少 4 块盘。n/2 块磁盘坏掉，还可以正常工作。N 块盘组合后的磁盘空间为：N/2。

## LVS, Nginx, HAProxy 有什么区别，怎么选择

简单来说：

- LVS：四层

- Nginx：七层

- HAProxy：四层和七层都可以

lvs 一般还和 keepalived，来实现 vip 的高可用。

- keepalived: 控制器故障转移的 VRRP 协议

## CDN

https://cloud.tencent.com/developer/article/1779335

### 理解

CDN 最重要的用途：为了加速网站的访问（就近访问）。

CDN 主要功能是在不同的地点缓存内容，通过负载均衡技术，将用户的请求定向到最合适的缓存服务器上去获取内容。

在用户和服务器之间增加缓存层，将用户的访问请求引导到最优的缓存节点而不是服务器源站点，从而加速访问速度。

CDN 的加速资源是跟域名绑定的。

### 场景

1、网站站点/应用加速（静态资源）

2、视音频点播/大文件下载分发加速

3、视频直播加速

4、移动应用加速

## 代理服务器

应用层（HTTP，FTP）代理服务器:

- squid：磁盘缓存（企业版一般用它）

- varinsh：内存缓存

传输层（TCP）代理服务器：

- sock5

docker 代理服务器：

- https://github.com/dqzboy/Docker-Proxy

## 中间件

中间件这个概念，主要侧重用途。

如果一个软件，他的主要用途是让不同的应用交换数据，或者作为分布式系统中的数据交换工具。

当以数据交换这个角色来讨论时，它就是中间件。

比如：

- mysql 如果是作为不同应用的数据共享层，那他就是中间件。

- mysql 如果只是后端服务的一部分，用来存储、检索数据，那就不是中间件。

## LVS 四种模式

使用 lvs 后一般的访问流程为:CIP<==>VIP==DIP<==>RIP。

- CIP:客户端的 IP。
- VIP:虚拟服务 IP，LB 的外网 IP，也就是客户端请求的 IP。
- DIP:LB 内网的 IP，负责与 RS 的连接与通信。
- RIP:RS 的 IP。

四种模式：

- DR：修改数据包的目标 mac，返回流量不经过 LVS。要求：LVS 和 RS 在同一物理网段内，RS 上要配置 VIP。(最常见)
- TUN：不修改数据包，把数据包封装后，扔给某个 RS，返回流量不经过 LVS。要求：RS 上要配置 VIP。
- NAT：lVS 对请求数据包，修改 DstIP，对响应的数据包，修改 SrcIP。
- FULLNAT：LVS 对请求数据包，修改 SrcIP 和 DstIP，对响应数据包，修改 SrcIP 和 DstIP，这样，返回流量不经过 LVS。

文档：

- [LVS 的四种工作模式总结对比](https://blog.csdn.net/u011489186/article/details/120128981)

- [Lvs DR 模式的配置与部属图文详解（通俗易懂，适合入门小白）](https://blog.csdn.net/weixin_66924350/article/details/137177961)
- [LVS 模式二：隧道模式（Tun）](https://www.cnblogs.com/uthnb/p/9661464.html)

## Linux 软硬链接

软链接：相当于源文件的快捷方式。软链接文件的 inode 和源文件的 inode 不同，可以跨分区，删除源文件，软链接文件不可用。

硬链接：相当于源文件的另一个入口。硬链接文件的 inode 和源文件的 inode 相同，不可以跨分区，删除源文件，硬链接文件依然可用。

## 网站慢，定位

大方向上来看，网站慢，有三个方向的问题：（来回）请求慢、（服务端）执行慢、（本地）加载慢。

### 请求慢：

- dns 解析慢：ping

- 线路连接慢：traceroute

### 执行慢：

- 服务器瓶颈：cpu, mem, disk io, net io。
- 程序 bug：日志分析，哪一步慢
- 数据库：

  - 内网连接串
  - 数据库性能瓶颈
  - 死锁、慢 sql：show processlist;

    - 死锁：开发一起看
    - 慢 sql：索引，sql 优化

### 加载慢：

F12 看：

- 大文件：

  - 提高带宽、cdn 加速、压缩文件、减少 http 请求、异步加载、静态资源使用独立域名，减少 cookie 传输

- 外部链接：谷歌字体这些
- 404 资源：需要清除调用

https://zhuanlan.zhihu.com/p/101620459

## 机器卡，定位

### 找到有问题的进程

- cpu: top, pidstat, perf，找到有问题的进程

  - 过载
  - 空闲

- mem: free, sar，缓冲区是否持续变化，进程正在运行中，缓冲区分析工具来寻找进程
- disk: iostat/sar, pidstat，找到有问题的进程
- net: netstat, ifconfig, ss 查看发包

文档：

- [性能之巅：定位和优化程序 CPU、内存、IO 瓶颈](https://zhuanlan.zhihu.com/p/335091866)
- cpu: [性能：如何迅速分析出系统 CPU 的瓶颈在哪⾥](https://blog.csdn.net/zhizhengguan/article/details/121149656)
- mem: [性能：如何快速找出系统内存瓶颈](https://blog.csdn.net/zhizhengguan/article/details/120962195)
- disk: [基础：如何迅速分析出系统 IO 的瓶颈在哪里](https://blog.csdn.net/zhizhengguan/article/details/120986183)
- net: [性能：网络数据传输慢，问题到底出在哪里了？](https://blog.csdn.net/zhizhengguan/article/details/121196302)

### cpu 相关的问题

cpu 低，负载高：

- 负载说的是 cpu 任务队列，负载高，说明队列里面的任务多，但是 cpu 却不高。
- 一般的可能是：（磁盘/网络）I/O 耗时、内存 swap 交换频繁、大量进程/线程切换 cpu、僵尸进程

cpu 高：

- 找到有问题的代码：java

  - top：找到进程 id
  - top -Hp：找到线程 id
  - jstack 打印进程堆栈，grep 线程的堆栈信息，就能找到问题代码

- 找有问题的代码：python

  - [pystack](https://www.dongaigc.com/p/bloomberg/pystack)

cpu 占用高，top 找不到：

- 被攻击，top、ps 等系统命令被修改
- stat 命令查看 top, ps

[linux cpu 飙高原因排查（有手就行）](https://blog.csdn.net/qq_33709582/article/details/121615696)

[Linux 系统 CPU 使用率和负载高排查方法](https://help.aliyun.com/zh/simple-application-server/support/troubleshooting-method-for-high-cpu-usage-and-load-in-linux-system)

## linux 系统常见优化方案

硬件、os、应用

- os：

  - 文件系统、内存、网络、内核
  - /etc/sysctl.conf
  - /etc/security/limits.conf

- 应用：

  - 监控（指标、日志）

- [构建卓越：高性能服务器架构设计与优化的全方位探索](https://www.ctyun.cn/developer/article/619440788934725)
- [Linux 内核的参数优化（尽量详细的总结）](https://blog.csdn.net/alwaysbefine/article/details/123858239)
- [Linux 性能调优之网络内核参数优化](https://cloud.tencent.com/developer/article/2354364)

## 性能优化思路

### 代码

性能问题的识别、循环优化、算法优化、减少函数调用、内存管理、并发和多线程、代码重构、避免不必要的计算、编译器优化、性能测试

### 缓存

缓存（时间/频率淘汰算法）、

- 缓存的类型：

  - 内存缓存：Memcached
  - 分布式缓存：Redis
  - CDN 缓存
  - 浏览器缓存

- 缓存的三大经典问题：

  - 缓存穿透
  - 缓存击穿
  - 缓存雪崩

### 异步

- 异步队列：RabbitMQ, Kafka
- 作用：异步任务、应对流量激增、分布式系统数据一致性、异常重试
- [页面调 10 个上游接口，如何做高并发？](https://mp.weixin.qq.com/s/eazMPWdVL5Ge1YaGeH5Dsw?spm=a2c6h.12873639.article-detail.6.2b7d5b93sNXfsb)

### 数据库

- 索引、复合索引（复合索引的使用遵循“最左前缀”原则，即查询条件必须从索引的最左列开始，并且不能跳过中间的列。）
- 查询优化：join 替代子查询，select 指定的字段
- 热读数据缓存
- 数据库参数
- 数据库缓冲区
- 分库分表（一千万的记录不用分）
- 读写分离：读库、写库；负载均衡
- 定期索引重建
- 批量执行语句

### 过载保护

- 资源隔离：关键资源与非关键资源隔离，减少影响
- 动态扩缩容：
- 限流：限制请求、任务进入/执行数量。
- 熔断：下游服务异常时，快速返回，防止异常蔓延
- 降级：系统压力过大时，降低非关键服务的质量。

### 前端

- 浏览器访问优化：减少请求、利用缓存、压缩
- CDN
- 反向代理也可以做一部分缓存
- web 组件分离：

  - 不同域名资源并行下载
  - 静态资源使用独立域名，减少 cookie 传输

### 硬件

disk, mem, cpu, nic, gpu

### 微服务架构

- 一个常见的系统：前端 - 展示 - 流量接入层 - 服务层 - 中间件层 - 数据库 - 基础设施
- 简单分为：接入层 - 服务层 - 持久层
- 常见的微服务组件：服务注册、服务发现、负载均衡、服务网关、配置中心、**支撑平台**、集成框架、分布式事务、调用链、API 管理。
- 支撑平台：

  - 重要性：系统微服务化后，系统将变得碎片化，系统的部署、运维、监控都将比单体应用复杂程度几何倍数上涨，那么，就需要将大量的工作自动化，CI/CD，灰度发布、健康检查、性能监控等等。可以这么说，支撑平台技术不足，就不要使用微服务架构。

- 服务网格，无入侵的服务治理
- 容器化与编排
- 大型中台化架构：

  - 中台不是从零开始，而是需求驱动，公司一定是已经积累了行业内很多场景的业务和技术能力，只不过因为要解决系统重复建设、能力复用性低，开始建设中台，服务业务与技术。
  - 但是不要觉得业务量一上来，立马就要建设中台，现在云平台的支撑能力已经很高了，抗住 1w 的 qps 不成问题。

### 度量与监控

度量指标定义

Prometheus, Grafana, alertmanager

elk（k 报警）

文档

- [大厂性能优化的 10 大顶级方案 （万字图文史上最全）](https://developer.aliyun.com/article/1627867)
- [DDD（Domain-Driven Design，领域驱动设计）](https://blog.csdn.net/Goligory/article/details/142790761)是一种软件开发方法，也是一种思想，它强调软件系统设计应该以问题领域为中心，而不是技术实现为主导。
- [什么是业务中台、数据中台、技术中台？这回终于解释清楚了](https://blog.csdn.net/xianshengsun/article/details/127187564)
- [ES8 生产实践——ELK 监控与告警(Kibana)](https://blog.csdn.net/qq_33816243/article/details/132352607)

## mysql 相关

### mysql 分库分表分区分片

- io 瓶颈：

  - 磁盘读 io 瓶颈：读的热点数据太多，数据库缓存放不下，每次查询都会有大量 io
  - 网络 io 瓶颈：请求的数据太多，网络带宽/数据库连接不够

- cpu 瓶颈：

  - sql 本身要优化
  - 查询数据量大

- 分表（侧重提高并发性能）：

  - 应用层面（一般指这个）

    - 垂直拆分：分字段
    - 水平拆分：分记录

  - 代理层面：通过代理 merge 引擎，将表分成若干子表，对应用保留一个“表壳”。

- 分区（提高读写性能）：

  - 将一张表分散存储在不同物理块中。

- 分库（提高数据库本身的瓶颈）

  - 就是垂直切分，按逻辑将表存在不同的库中

- 分片（能不用就不用）

  - 相当于分库+分表

doc:

- [一篇文章搞懂 MySQL 的分库分表](https://blog.csdn.net/qq_40991313/article/details/133797658)
- [MySQL 的分片（二）——MySQL 分片](https://blog.csdn.net/RL_LEEE/article/details/83143335)
- [(二十三)MySQL 分表篇：该如何将月增上亿条数据的单表处理方案优雅落地？](https://developer.aliyun.com/article/1575646)
- 分布式数据库中间件：[大厂原来都这么对 MySQL 分库分表!（上）](https://developer.aliyun.com/article/838437)
- 分布式多租户数据库：[Django-Multitenant，分布式多租户数据库项目实战](https://cloud.tencent.com/developer/article/1970015)

### 慢 sql 怎么处理

慢 sql，就是指执行时间较长的 sql 操作。

导致慢 sql 的原因：

- 缺乏索引
- 数据量大
- 查询条件不当：where/子查询/join 不对
- 锁等待
- 硬件资源不足
- 设计不合理

怎么处理：

- 增加索引、定期重建索引
- 分库分表、定期清理无用数据
- 优化查询
- show processlist, explain（django 这些不常用）
- 升级硬件资源

文档：

- [慢 SQL 是什么？产生的原因是什么？如何解决和优化？](https://blog.csdn.net/caokun_8341/article/details/136858665)

### 主从同步方案

binlog+position

- 异步复制（主库事务不等待一个从库成功）
- 半同步复制（主库事务只等待一个从库成功）

  - 5.7.2 有一个幻读问题
  - 5.7.2 之后增加一个参数，主库事务等待成功返回，主库再提交。

- 全同步复制（主库事务需要等待所有从库成功）

GTID（Global Transaction Identifier）：

- 是 MySQL 5.6 及以后版本中引入的一个关键特性，以事务为单位管理复制，不再需要靠 log_file 和 log_pos 来定位复制位置，在主从切换、故障恢复时更加简单。
- GTID 实际上是构建在 binlog 之上的一个增强功能，它利用 binlog 来记录事务，并提供全局事务的唯一标识，从而实现更高效和安全的复制管理。
- [超详细的 mysql 数据库 GTID 介绍](https://blog.csdn.net/HD243608836/article/details/109578131)

- [基于 GTID 搭建主从 MySQL](https://www.cnblogs.com/ZhuChangwu/p/13040214.html)

MHA（Master High Availability）

- 目的在于维持 Master 主库的高可用性。
- 目前 MHA 主要支持一主多从的架构，要搭建 MHA,要求一个复制集群中必须最少有三台数据库服务器
- 侧重点在切换，需要自行准备 vip 切换等工具、脚本
- [MySQL 高可用方案--MHA 原理](https://www.cnblogs.com/brianzhu/p/10154708.html)

MGR（MySQL Group Relication）

- mysql 官方的高可用、强一致、vip 切换

可以考虑：

- MGR+单主+异地 slave

文档：

- [MySQL 主从复制原理和使用](https://developer.aliyun.com/article/1631581)
- [这次终于把 MySQL 主从复制总结全面了！！！](https://cloud.tencent.com/developer/article/1822790)
- [MYSQL 高可用架构 MGR、MHA 对比](https://www.cnblogs.com/xiaoyuxixi/p/13814811.html)

### mysql 怎么不停机迁移

方法一：代码修改：双写双读

- 挂从库
- 修改写入代码：双写
- 新老库迁移
- 数据追平校验
- 修改读取代码：双读
- 灰度只读新库
- 关闭老库写入
- 去掉无用的双读、双写代码

方法二：代码修改：双读（不用双写）

- 挂从库
- 开启数据同步：DataX, DBSyncer, canal, databus 等工具实现数据迁移
- 数据追平校验
- 修改读取代码：双读
- 灰度只读新库
- 代码只写新库
- 关闭数据同步
- 去掉无用的双读代码

文档：

- [数据迁移还需要停机？不停机上线的正确姿势你能 get 到吗？](https://zhuanlan.zhihu.com/p/180425117)

## 分布式数据库

[什么是分布式数据库？](https://tidb.net/book/tidb-monthly/2022/2022-10/development/what-is-distributed-database)

## redis 和 memcache 区别

没研究过，主要就是 redis 了。

## 常见 web 攻击

ddos 攻击：主要针对 ip，影响整个网络。通过大量，分布，持续的请求，淹没正常请求，或者耗尽服务器资源（cpu, mem, net）。

cc 攻击：主要针对网站页面，影响 web 服务。通过模拟真实用户，攻击那些需要大量计算资源来处理的页面。

waf：

- 根据 ip、url，来进行允许、拒绝。

- 黑白名单、区域封禁、规则防护

## docker 相关

### docker 安全隐患

最主要的就是特权模式、非官方镜像。

### docker 网络模式

默认 bridge，微服务用 overlay。

其他：host, none, container

[docker 六种网络模式](https://blog.csdn.net/m0_74282926/article/details/144192896)

## time_wait 过多怎么处理

time_wait：

- 原因：

  - 出现在“客户端”角色的服务器上。但是在 web 服务器上，HTTP 协议基于 TCP 协议，关闭 TCP 连接的是 Server 端，所以 web 服务器上就会出现很多 time_wait。
  - 要么是对方没有返回，要么是自己没有重用。

- 解决：

  - 修改内核参数，服务器能够快速回收和重用那些 TIME_WAIT 的资源。
  - 负载均衡，增加服务能力，提高服务器个数。

- 文档：

  - [服务器 TIME_WAIT 和 CLOSE_WAIT 详解和解决办法](https://zhuanlan.zhihu.com/p/60382685)
  - [【Linux】TIME_WAIT 的作用、影响、解决方法](https://blog.csdn.net/Mr_EvanChen/article/details/107020414)

close_wait

- 原因：

  - 对方关闭了链接，自己没有关闭。
  - 这种就是服务本身的问题，服务器对于程序抢占的资源，没有主动回收的权利，除非终止服务运行。

## tmpfs 是什么

拿出一部分内存空间，来存储文件。它的 io 速度会远大于磁盘 io。

但是重启会被清空。

文档：

- [linux 中 tmpfs 详解](https://blog.csdn.net/yuhengyue/article/details/106787358)

## 虚拟化工具

windows:

- VMware Workstation Player
- VirtualBox
- QEMU
- Proxmox VE
- Hyper-V
- Parallels
- Gnome Boxes
- Red Hat Virtualization
- Boot Camp

Linux

- OpenVZ
- KVM
- Xen
- oVirt

集群

- openstack: [\[云计算\]OpenStack 这一篇就够了！](https://www.cnblogs.com/Skybiubiu/p/16561169.html)

## 标准作业程序 SOP（Standard Operate Procedure）

标准作业程序，将某一事件的标准操作步骤以统一的格式描述出来，用于指导和规范日常工作。

## rabbitmq, rocketmq, kafka, pulsar

- 吞吐量在十万以下：rabbitmq
- 吞吐量在十万~百万：rocketmq
- 吞吐量在百万级以上：kafka、pulsar

[2024 消息队列“四大天王”：Rabbit、Rocket、Kafka、Pulsar 巅峰对决](https://blog.csdn.net/citywu123/article/details/141950838)

## 混沌工程

在高可用系统中，注入各种各样的 “哦，原来这也能出现的”错误。

从成本上考虑，我们不需要模拟所有的故障，进需要考虑那些经常发生的故障。

[混沌工程(Chaos Engineering) 到底是什么?](https://cloud.tencent.com/developer/article/1622874)

## 无线带宽 InfiniBand (IB)

是一种高带宽、低延迟，涉及到多种技术与硬件。

IB 交换机、IB 网卡。

万兆，4 万兆，6 万兆，十万兆。

RDMA over Converged Ethernet (RoCE)

[Infiniband 技术概述](https://www.cnblogs.com/augustone/articles/18261227)

## 监控-夜莺

夜莺监控（ Nightingale ）是一款国产、开源云原生监控分析系统。

[夜莺项目介绍](https://flashcat.cloud/docs/content/flashcat-monitor/nightingale/introduction/)

## airflow

Airflow 更适合于数据处理任务，如 ETL（提取、转换、加载）流程。

[如何学习 Airflow：糙快猛的大数据之路](https://blog.csdn.net/u012955829/article/details/140566899)

## weblogic/websphere

[几种常见 web 容器比较 （tomcat、 jboss 、resin、 weblogic、 websphere、 glassfish）](https://blog.csdn.net/fuhanghang/article/details/104370187)

## 高性能计算 HPC：slurm、LSF、PBS

在高性能计算（HPC）领域有着广泛的应用，如科学计算、工程分析、数据分析等

在高性能计算（HPC）领域，Slurm 被广泛用于管理集群资源和调度作业。

与其他作业调度系统（如 IBM 的 LSF 和 PBS）相比，Slurm 的一个显著特点是它不需要修改操作系统内核，使其更易于集成和使用。

[Slurm 作业调度系统的简介及基本使用](https://blog.csdn.net/lejun_wang1984/article/details/135180652)

## eBPF（extended Berkeley Packet Filter）

eBPF 相对于 Linux Kernel，相当于 JavaScript 相对于 HTML。

增加了 Linux Kernel 的可编程性

[初识 eBPF（功能、原理、及一些应用）](https://blog.csdn.net/qq_24433609/article/details/125879684)

## MLOps、DataOps、AIOps、LLMOps

关系：

- DataOps 是 MLOps 的延伸。
- DataOps/MLOps/LLMOps/GenAIOps/RAGOps/...：

  - 是 Ops 在 Data/ML/LLM 领域的应用，主体是 Data/ML/LLM。
  - 管理各自生命周期的工具、最佳实践。

- AIOps 是 AI 在 Ops 领域的应用，主体是 Ops。

MLOps:

- 数据自动化准备
- 模型自动化训练、迭代
- 模型自动化部署、监控

LLMOps

- 选择基础模型
- 适配下游任务：提示工程、微调、外部数据
- 评估
- 部署和监控

[1 张表看懂 MLOps 与 DataOps、AIOps 的区别](https://zhuanlan.zhihu.com/p/501050506)

[10 分钟搞懂 LLMOps](https://developer.aliyun.com/article/1366955)

## 网络相关

### 证书

- 红帽认证工程师（RHCE），作为 Linux 操作进阶，侧重点在于掌握自动化批量化服务器管理，重点介绍自动化工具 Ansible 操作，包括 Ansible 介绍、Ansible 架构、Ansible 模块和命令、Ansible 剧本编写、Ansible 变量循环判断等等。
- HCNP(Huawei Certified Network Professional)，是华为网络认证的中级级别。
- HCIP(Huawei Certified ICT Professional)，是华为认证体系中的高级认证。
- H3CSE（H3CSE-Security 认证（安全技术高级工程师））是 H3C 推出的网络安全高级工程师认证，主要定位在从事信息安全产品安装、调试、运行、维护人员。涵盖当今网络安全领域三大热门技术：防火墙，VPN 和 IPS。

  - ISF（Implementing Secure Firewalls，部署安全防火墙系统）
  - BSVPN（Building Secure Virtual Private Networks，构建安全 VPN 网络）
  - AIPSC（Advanced Intrusion Prevention System Configuration & Security Audit，入侵防御系统与安全审计）
  - H3CSE Ruting & Switching（H3C Certified Senior Engineer for Routing & Switching，H3C 认证路由交换网络高级工程师）证书可以证明其持有者掌握了包括路由、交换、组播、VPN、QoS、基本安全特性等部署园区网络所需的全方位的理论知识和操作技能，可以胜任大中型复杂网络的建设和管理工作。
  - [H3C 认证体系](https://baike.baidu.com/item/H3C%E8%AE%A4%E8%AF%81/7855275?fromModule=lemma_inlink)

# k8s

- 面试题：https://blog.csdn.net/crazymakercircle/article/details/128671196

## k8s 是什么

是一套容器编排系统，可以对给予容器的应用、服务实现全生命周期的管理。包括应用部署、更新、监控、扩缩容等。

## 介绍下 k8s 的基础组件

### 组件有什么

master: kube-scheduer, kube-apiserver, kube-controller-manager

node: kubelet, kube-proxy

其他：etcd（可以独立于 master 节点），coredns

### 各个组件作用

kube-apiserver: 所有组件的通信，都会经过 apiserver

kube-scheduler: 调度机群资源

kube-controller-manager: k8s 自动化能力（部署、更新、扩缩容）的核心。像：deployment/replication/endpoint controller

etcd: key-value 数据库，保存 k8s 资源对象的信息。集群个数一般为奇数个（仲裁选举容错模式）。

kubelet: 管理 Pod 的生命周期的

kube-proxy: 实现 node 上 pod 的网络通信能力。主要通过 iptables，还有 ipvs

coredns: 实现 k8s 内部 svc 和 pod 的域名解析

## k8s 基础概念

master: 管理节点

node: 工作节点，或叫 worker

工作负载：工作负载就是应用程序，应用程序就是一组 pod，不过一般不直接管理 pod，而是通过 deployment, daemonset, stateset, job/cronjob 等进行管理

Namespace: 不同 namespace 的资源（工作负载）是隔离的。

pod: k8s 的最小调度单元，一个 Pod 可以有多个容器，这些容器共享相同的 Namespace, 网络，端口，可以通过 Localhost 访问。debug 时候就利用的这一点。

- 探针：启动、存活、就绪

service: pod 的 ip 会因为 pod 异常而变化，所以用 service 来进行统一入口，四层的负载均衡

- 四种 service 类型：cluster ip（默认）, node port, load balance, external name

endpoint: service 和 Pod 并不会直接相连，中间有一层 endpoint，来记录 ip,port

ingress：service 是四层的，实际中，需要一个七层的代理，他就是干这个用的。ingress - service - endpoint - pod

deployment: 无状态应用通过它管理（web）。动态控制 Pod 的属性（镜像）、状态（个数--扩缩容（rs, rc），），有了 deployment，不再用 rc, rs。

replication controller：不怎么用，一般通过 deployment 修改它。

replicaSet：更不怎么用

statefulset：有状态应用通过它管理（mysql）。

job: 一次性任务

CronJob：定时任务

label: 标签，K8s 通过标签筛选资源

存储：

- Volume：跟 pod 的生命周期保持一致，一个 pod 对应一个 volume
- pv：独立于 pod 的生命周期，一个 pv 对应一个 volume
- pvc：PVC 是一个声明，有了 PVC，k8s 会用现成的 PV，或者创建一个 PV 来供 pod 使用

自动扩缩容：

- HPA：pod 横向扩容，增加 pod 个数。cpu 利用率，qps。
- VPA：pod 纵向扩容，增加 pod 资源。

CRI: containerd, docker

CNI: Flannel, Calico

CNM：docker 公司的

CRD：自定义资源。很多组件都是自定义资源。

DNS：servicename.namespace.svc.cluster.local, pod-ip-address.namespace.pod.cluster.local

IPVS：是 linux 提供网络负载均衡的内核模块，kube-proxy 的网络模式有两种 iptables（规则列表），ipvs（规则哈希表）。

## pod 相关问题

### pod 定义

pod 是 k8s 最小操作单元，一个 pod 可以包含多个容器，这组容器的有网络、存储资源是共享的，比如可以通过 localhost:port 来访问彼此。

### pod 共享资源

- pid namespace
- network namespace: ip, port
- IPC namespace: inter-process communication. different containers in one pod can communicate with each other;
- UTS namespace: UNIX Time Sharing, hostname, domain,
- pod volumes

[pod 容器间哪些共享、哪些隔离](https://www.cnblogs.com/huangjiabobk/p/18362245)

### pod init container

先于应用容器的容器，必须成功退出，才会往下执行

一个 pod 可以有多个 containers，也可以有多个 init containers。

### pod pause container

pause container 相当于 pod 的根容器，它会在 init containers 启动完成后，所有 app containers 启动前启动。

作用：

- 创建共享的 namespace(ipc, uts, net, pid)，
- pod 级别 volumes，
- 启动 init 进程，回收僵尸进程。

### pod command, args 与容器的 entrypoint 怎么运行

覆盖关系。

command 不为空，会覆盖 entrypoint

command 为空，arg 不为空，会使用 Pod 的 args 执行 entrypoint

### pod 创建流程

- deployment/daemonset yaml -> apiserver

- apiserver: 验证，创建 pod 对象信息，存储 etcd。状态为 pending
- scheduler watch apiserver

  - 过滤：根据 node selector, 申请资源匹配，节点亲和
  - 打分：根据规则来的。比如资源使用率最低、同一个 service 拆开
  - 选择 node
  - 更新 etcd

- kubelet watch apiserver:

  - create pod, by call CRI( docker, containerd).
  - update etcd

### pod 销毁流程

- apiserver: 验证，修改 pod 对象信息。更新 etcd（宽限期，默认 30s）。状态为 Terminating。
- kubelet watch apiserver：

  - send sigterm(kill -14) to CRI
  - run prestop hook(if exist)

- endpoint controller watch apiserver:

  - delete endpoint

- kubelet (grace period expired):

  - send sigkill(kill -9) to CRI
  - response apiserver pod will delete immediatly

- apiserver:

  - delete pod from etcd.

文档：

[pod 的创建、销毁流程](https://blog.csdn.net/sailor_q/article/details/117234544)

### pod 的状态

- Pending

  - 持续 pending 的原因：

    - 镜像 Pull 不下来
    - 没有合适的 node
    - pv, pvc 无法成功创建

- Running
- Successed
- Failed: failed at least one pod
- Unknown: may cause by network communicate problem

[Pod 的生命周期](https://blog.csdn.net/be_racle/article/details/138508898)

### pod 怎么发现 service 的

- 环境变量：创建 pod 时，会把有效的 service 和 ip 的对应存到环境变量中
- CoreDNS：FQDN 来访问

### 聊聊 pod 通信机制

- pod 内容器间：lo 回环地址
- pod 间：overlay 网络（覆盖网络）
- pod 与 service：各 node 上的 iptables 或 ipvs

### pod 的 SLA：QOS

QOS 就是在 node 资源不足的时候，清理 pod 的顺序。

三种 QOS（不被清理优先级从高到低）：Guaranteed > Burstable > Best-Effor

- Guaranteed：所有容器，cpu 和 mem 的 request 和 limit 都一致
- Burstable：任一容器，cpu 或 mem 的 request 和 limit 不一致
- Best-Effor：所有容器，都没有指定 cpu 或 mem 的 request 和 limit

[聊聊 K8S pod 的 QoS](https://developer.aliyun.com/article/1344979)

[浅谈 K8S QoS(服务质量等级)](https://cloud.tencent.com/developer/article/1638798)

## 标签相关

### 标签的理解

标签是 key-value 形式的键值对，可以附加在任何资源对象上，用于管理对象，匹配、筛选。

比如 deployment, service 和 pod 的匹配关系，就是通过标签选择器来实现的。

## service 相关

### 如何创建一个外部 service，比如 mysql

- 创建一个没有 label selector 的 service，这样就不会创建 endpoint。但是其他信息要填写。比如 port 的端口号、名称、协议等等。
- 手动创建一个 endpoint。endpoint 中定义外部服务的 ip, 端口等。endpoint 的 name、port name, port protocol 要与 service 的一致。

### service, endpoint, kube-proxy 三者的关系

- service 是因为 pod 不会 100%可用，一组 pods 中，有的 pod 随时会重启，而为着一组 pods 提供不变的接入点
- endpoint 是一组 pods 的 ip, port 的列表，一般由 service 自动维护，有时也会手动做一些处理，比如定义外部资源类型的 service

  - 有 endpoint controller，没有 service controller。

- kube-proxy 是运行在每一个 node 上的网络代理，通过 iptables 或 ipvs，将 service 和 endpoint 的信息转换为网络规则，从而实现对 pods 的流量转发。

### 无头 service

一般用于

- 为每个 Pod 创建了独立的 DNS 记录，主要用于有状态应用集群（redis/mysql/...）的集群内节点间的服务发现

[**K8S 部署 Redis Cluster 集群（三主三从模式）**](https://www.cnblogs.com/kevingrace/p/14412134.html)

## deployment 相关

### 扩缩容

- 修改 yaml：replicas
- kubectl scale

### 发布策略都有什么

deployment 自带：

- rolling update
- recreate

通过 deployment

蓝绿：

- 两个 deployment，修改 service 的 label selector
- 两套 service+deployment，修改 ingress

金丝雀：

- 最笨：启动相同 label 的 v2 pod，相当于通过 k8s service 自带的流量策略实现金丝雀
- ingress annotation 实现基于：cookie, header, 流量比例
- istio：todo

### 滚动发布的 2 个重要参数

- 更新过程中，最大不可用 Pod 数量：maxUnavailable
- 更新过程中，最大激增 Pod 数量：maxSurage

### 滚动发布的过程描述

1.  增加 maxSurage 个新 pod
2.  删除 maxUnavailable 个旧 pod
3.  重复 1,2 两步，直到所有 pod 都为新 pod

### 怎么回滚

rollout history 查看都有什么版本可以回滚

rollout undo 进行回滚

## 存储相关

### Volume

生命周期与 pod 相同

常见的 volume 类型：

- emptyDir：空目录
- hostpath：不常用
- configmap：不加密配置
- secret：加密配置
- pvc：持久存储声明
- 网络存储：nfs

[volume 类型](https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#types-of-volumes)

### PersistentVolume 的意义

pv 存在的意义就是：

- 更加灵活地管理存储，
- 解耦存储的管理和应用的管理。

[支持的 persistentvolume 类型](https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes)

[kubernetes 存储系统 Volume 和 PV](https://cloud.tencent.com/developer/article/2234476)

### PV 访问模式

- 单节点读写 RWO
- 多节点只读 ROX
- 多节点读写 RWX

### pv 怎么扩容

主要看 storageclass 的 allowVolumeExpansion 字段。true/false

### PVC 的意义

PVC 是应用定义 yaml 中使用的

PV 是运维人员管理的

### storageclass

sotrageclass 就是为了减少人工而去自动创建 pv 的组件

[大白话说明白 K8S 的 PV / PVC / StorageClass](https://developer.aliyun.com/article/1326853)

## node 相关

### node 调度都有什么

功能

说明

cordon（警戒）

影响：

- 不允许新的，已有 pod 保留；

如何恢复：kubectl uncordon node_name

drain（驱逐）

影响：

- 驱逐已有 Pod，调度到其他 node 上；
- 不允许新的。

如何恢复：kubectl uncordon node_name

delete（删除）

影响：

- 驱逐已有 Pod，调度到其他 node 上；
- 从 master 节点删除该 node，master 不可见该节点

如何恢复：

- master 不可恢复这个 node
- 利用节点自注册功能：重启 node kubelet。

taints（污点）

Tolerations（容忍）

污点：给 node 增加污点：key:\[value:\]effect

- kubectl taint nodes k8s-node01 check=zhang:NoSchedule
- effect: 不调度、优先不调度、不调度且驱逐已有的

容忍：给 pod 增加容忍：

- 特殊：tolerationSeconds：当可以容忍 NoExecute 的污点，但是对应时间后会被驱逐

Affinity（亲和）

AntiAffinity（反亲和）

因为有硬/软亲和、节点/pod 亲和，所以，共有如下几种情况：

- 节点硬亲和，节点软亲和，节点硬反亲和，节点软反亲和
- 节点硬亲和，节点软亲和，节点硬反亲和，节点软反亲和

总的来说：

- 亲和：与已有的 pod 在一起。

- 节点亲和：根据节点的标签，来决定亲和/反亲和此节点
- Pod 亲和：如果 A 拓扑域，已经运行了满足 labelselector 的 pod，则亲和/反亲和此拓扑域。
- 硬亲和：必须亲和/反亲和此节点/拓扑域
- 软亲和：优先亲和/反亲和此节点/拓扑域

TopologyKey（拓扑域）

拓扑域：就是拥有相同 label(key & value)的一组 node，称在一个拓扑域中。

topologySpreadConstraints

（拓扑分布约束）

根据指定的 TopologyKey，来定义偏移量限制

[Cordon、Drain、污点与容忍度、亲和性与反亲和性](https://www.cnblogs.com/ydswin/p/18042437)

[K8s 中污点(Taint)详解及命令](https://cloud.tencent.com/developer/article/1762009)

[k8s 官方文档-污点和容忍](https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/)

[k8s 详细文档：亲和与反亲和](https://cloud.tencent.com/developer/article/1746649)

[【K8s 概念】Pod 拓扑分布约束](https://www.cnblogs.com/varden/p/15064412.html)

### kubelet 的 node 监控怎么实现的

- metrics-server：提供 kubectl top api 数据。
- cAdvisor：容器监控组件

## 印象深刻的问题

### CoreDNS 响应在 Alpine 系统报错的问题

CoreDNS 低版本有个 bug，IPV6 的 DNS 响应是 NXDomain，而当 DNS 客户端系统是 alpine 系统时，会报错，其他系统（Ubuntu 等）不会报错。升级 CoreDnS 后解决。

踩坑：CoreDNS 日志、iptables、iproute、flannel、kubelet、kube-proxy

### 脑裂问题

脑裂问题是分布式系统的共性问题，keepalived, redis 集群，都有可能出现这个情况。

出现这个情况的原因，就是网络问题，导致集群被分成了两个或多个。

一般解决就是：加仲裁者、心跳检测。运行一个检查脚本，持续监测网关连通性，不通则关闭本机分布式服务。如 keepalived。

[脑裂问题与解决](https://blog.csdn.net/qq_47855463/article/details/119790396)

# 开发

## springcloud

springcloud 是 java 语言的一个高度集成的微服务框架。

[SpringCloud 从入门到精通](https://blog.csdn.net/cuiqwei/article/details/118329609)

# HR

## 请简单介绍一下你自己

姓名，毕业时间，从业时间，公司流，工作内容，个人优势 ABCD，总结

### 运维开发

面试官你好，我是于川，陕西人，15 年毕业参加工作，到现在有 9 年的工作经验。9 年内工作过的公司主要是 2 个，西安的华为外包，北京的创新奇智，4 年前，因为家庭原因回去西安待了 2 年，然后 2 年前，我又回来了北京的创新奇智，一直到现在。

然后工作内容主要是，刚入行时就是基于 linux 的 CI/CD，运维自动化，主要是 shell, Python，windows 的 bat 也写过。再往后就是运维平台，运维平台就涉及到 cmdb, 统一登录，跳板机，批量运维（ansible, salt 这些）。再之后运维平台趋于稳定，做的工作，就逐渐往开发上侧重，参与开发的主要就是公司内部的 ERP 系统开发，以及主导过一个集团级别的统一登录基础组件的开发，这个基础组件最后达到的性能标准是核心功能 1w 并发下 200ms 内延迟。

最后，我简单总结一下。

我的经验主要有 2 个。1，运维，刚入行，到现在，一直在做运维，像 CI/CD，运维自动化，docker，k8s，这些都是一直在做的。2，开发，主要就是 Python，不管是运维自动化，运维平台，还是后来的 ERP 系统开发，都用的是 Python。

然后我看咱们岗位描述上，写的是做 cmdb 的开发，以及要有相关的经验，我认为我的经验与能力，跟咱们的岗位很匹配，然后贝壳我也经常用，所以很期待能加入咱们公司。

## 你的优缺点

优点

- 独立解决问题的能力——运维

  - 自动化替换 linux 启动参数，启动指定操作系统，linux
  - svn 代码检视方案。reviewboard

- 结果思维，目标思维

  - 团队协作中，不看重分内分外，看重所在做的任务整体完成情况，以及我能做什么来推动整体的完成。
  - 开发过程中，与测试人员沟通，跟进完成任务，而不是最后出问题了，我在那说，这是测试的问题，我开发完了，他没测。

缺点：

- 大部分搞技术都会有的一个通病——有点追求完美

  - 写代码的注释，运维的文档，这些边边角的，都会想写好，然后就会推己及人，有的时候拿到别人写的维护文档，就感觉，有很大的优化空间。
  - 当然，这个主要影响的是自己。而且随着工作时间的增加，也不会要求别人了，做好自己能做的，毕竟是合作。

- 性格是有些偏内向的

## 特别成功的一件事

### 代码检视

不到两周时间，从零开始调研 svn 的使用场景，从搭建，使用，代码检视，输出一份类似于红宝书一样的 ppt，然后给研究院同事培训。

前面的搭建、使用，还好，运维基础能力就能覆盖，可能整理成 ppt，需要将一些琐碎，流程性的东西抽象出来，这个倒也还好，就是后面的代码检视，一开始以为没有什么，开始调研方案，选型，部署、搭建，在配置使用阶段一度阻塞，一个是文档都是英文的，另外一个因为想着尽力减少使用者的步骤，所以在提交代码前钩子脚本编写那里，想自动化很多，但是实现不了，最后快到日期了，我强迫自己冷静下来，思考这个事情的本质，我们的目标是要一个方案，而不是特别少的步骤，于是调整了下方向，做了一些交换，步骤变多了 1 步，但是可落地方案有了，最后的培训也很成功，CTO 很满意。

### 主导整体架构性能优化

起因是用户反馈网站慢，我们就开始排查。

网站慢，一般就是 3 个问题：网络慢、服务端响应慢、客户端加载慢。

网络，ping, traceroute，都是好的

服务端，服务器：cpu, mem, disk, net，也都没到瓶颈，代码：顺着网站慢的接口，一路捋代码下来，发现有个与数据库的交互卸载了循环中，导致与数据库的交互太多，就慢。

简单的这一次通过加缓存解决了。但是，我提议对我们的架构进行整体、系统地优化。然后也得到通过了。

于是，我们开始系统排查核心业务，这不查不知道，一查就发现有很多可以优化的。

前端，后端，整体架构，都进行了优化。

最后下来，我们采取的措施不少，常见的性能优化的措施都采取了。

前端：cdn, 一些业务做了异步加载

后端：代码优化，缓存

数据库：索引优化，定期重建

过载保护：动态扩缩容，资源隔离，下游熔断，限流、降级

## 未来的职业规划

我的从业以来的工作经验，集中在运维、开发这些方面。未来首先肯定是计划基于我的能力栈，技术能力进一步深化，将自己的技术在不同的场景、平台下使用。

往专家的方向发展。

跟同事一起，完成更大的挑战。

## 为什么离职/换工作

部门的工作重心变得偏向做更多“不会错”的东西，而不是去优化现有架构，提升稳定性、健壮性。

我这边明年的工作重心是完成 8+安全证书的申请。

我不否认安全很重要，但是他跟我的技术发展方向实在是偏离太多，而且跟领导也沟通过，这个不会变，做更多“不会错”的东西的战略，一两年来看，也不会变。

## 你还有什么想问的吗

野心，忠诚度

我想问下，如果我能有幸入职，您对岗位的要求或者期望是什么样的？

## 简单介绍下你的家庭情况

我去年刚结婚，我是陕西，我媳妇是河北的，她跟我都在北京，一起奋斗，我们两的梦想，就是能在北京买套房。

## 你的核心竞争力是什么

我觉得就是我刚说的优点，一个是解决问题的能力，运维经验丰富，运维这个行业，有点类似于老中医，见得越多，解决问题的思路与方法就越多。另一个就是结果思维，也可以说是责任意识。

## 你认为管理者需要有什么样的素质

从我的经验来看，对下需要有任务拆解能力，对上要有总结和全局把控、方向把控的能力。

## 你对薪资的要求

先问下公司的薪酬架构，然后参考行业平均工资和 JD 给出的区间，取中上值。

## 你对加班的看法

肯定是可以接受，因为工作中计划外的情况肯定会出现，所以工作需要，我觉得义不容辞，不过，我也不会刻意地为了加班而加班。

总之就是，必要的加班完全能接受，不必要的加班，还是尽量要避免。

## 你觉得对于你应聘的岗位，你还有哪些欠缺的地方

岗位说明，我仔细看过了，我为需要的是 XX 能力，XX 能力，而这些能力，我是都具备的。欠缺的，应该就是对业务的理解程度。

这个入职后，我也会尽快熟悉起来，补齐短板，贡献自己的力量。

# 更多

## 岗位简写

- HR（Human Resources）人力资源
- IT（Information Technology）信息技术
- BD（Business Development）商务拓展
- PR（Public Relations）公共关系
- RD（Research & Development）研发部门
- MKT（Marketing）市场
- CS（Customer Service）客户服务
- CEO（Chief Executive Officer）首席执行官
- COO（Chief Operations Officer）首席运营官
- CFO（Chief Financial Officer）首席财务官
- CIO（Chief Information Officer）首席信息官

## Go 语言

[Go 语言学习路线图](https://javabetter.cn/xuexiluxian/go.html)

[awesome-go-cn](https://github.com/jobbole/awesome-go-cn)

[Go 语言圣经（中文版）](https://books.studygolang.com/gopl-zh/)

[Go 编程时光](https://golang.iswbm.com/)

[gin-vue-admin](https://github.com/flipped-aurora/gin-vue-admin)
